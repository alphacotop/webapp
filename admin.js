// admin.js - Î≥¥Ïïà Î∞è Í¥ÄÎ¶¨Ïûê Î™®Îìà
(function() {
    'use strict';

    // Î≥¥Ïïà Î™®Îìà - Ïö∞ÌÅ¥Î¶≠ Î∞è Í∞úÎ∞úÏûêÎèÑÍµ¨ Î∞©ÏßÄ
    const SecurityModule = {
        init() {
            this.disableRightClick();
            this.disableKeyShortcuts();
            this.disableTextSelection();
            this.disableDragDrop();
            this.setupConsoleWarning();
            this.detectDevTools();
        },
        
        // Í∞ïÌôîÎêú Ïö∞ÌÅ¥Î¶≠ Î∞©ÏßÄ
        disableRightClick() {
            // contextmenu Ïù¥Î≤§Ìä∏ ÏôÑÏ†Ñ Ï∞®Îã®
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }, true);
            
            // ÎßàÏö∞Ïä§ Ïö∞ÌÅ¥Î¶≠ Î≤ÑÌäº ÏßÅÏ†ë Ï∞®Îã®
            document.addEventListener('mousedown', function(e) {
                if (e.button === 2) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);
            
            document.addEventListener('mouseup', function(e) {
                if (e.button === 2) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }, true);

            // Ï∂îÍ∞Ä Ïö∞ÌÅ¥Î¶≠ Î∞©ÏßÄ (Î™®Îì† ÏóòÎ¶¨Î®ºÌä∏Ïóê Ï†ÅÏö©)
            document.addEventListener('contextmenu', function(e) {
                return false;
            });
            
            // oncontextmenu ÏÜçÏÑ±ÎèÑ Ï∞®Îã®
            document.oncontextmenu = function() { return false; };
        },
        
        // Í∞úÎ∞úÏûêÎèÑÍµ¨ ÌÇ§ Ï°∞Ìï© Î∞©ÏßÄ
        disableKeyShortcuts() {
            document.addEventListener('keydown', function(e) {
                // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S Î∞©ÏßÄ
                if (e.key === 'F12' || 
                    e.keyCode === 123 ||
                    (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key)) ||
                    (e.ctrlKey && ['u', 'U', 's', 'S'].includes(e.key)) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
                    (e.ctrlKey && e.keyCode === 85) || // Ctrl+U
                    (e.ctrlKey && e.keyCode === 83)) { // Ctrl+S
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
                
                // Ctrl+A (Ï†ÑÏ≤¥ ÏÑ†ÌÉù) Î∞©ÏßÄ (Í¥ÄÎ¶¨Ïûê Î™®Îìú Ï†úÏô∏)
                if (e.ctrlKey && e.key === 'a' && !e.shiftKey) {
                    e.preventDefault();
                    return false;
                }
            }, true);
            
            // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä Ï∞®Îã®
            document.addEventListener('keypress', function(e) {
                if (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 117)) { // Ctrl+U
                    e.preventDefault();
                    return false;
                }
            }, true);
        },
        
        // ÌÖçÏä§Ìä∏ ÏÑ†ÌÉù ÏôÑÏ†Ñ Î∞©ÏßÄ
        disableTextSelection() {
            // JavaScript Ïù¥Î≤§Ìä∏Î°ú ÏÑ†ÌÉù Î∞©ÏßÄ
            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
                return false;
            }, true);
            
            document.addEventListener('mousedown', function(e) {
                if (e.detail > 1) { // ÎçîÎ∏îÌÅ¥Î¶≠ Ïù¥ÏÉÅ Î∞©ÏßÄ
                    e.preventDefault();
                    return false;
                }
            });
            
            // Ï†ÑÏó≠ ÏÜçÏÑ± ÏÑ§Ï†ï
            document.onselectstart = function() { return false; };
            document.onmousedown = function() { return false; };
            
            // CSSÎ°úÎèÑ ÏÑ†ÌÉù Î∞©ÏßÄ Í∞ïÌôî
            const style = document.createElement('style');
            style.innerHTML = `
                * {
                    -webkit-user-select: none !important;
                    -moz-user-select: none !important;
                    -ms-user-select: none !important;
                    user-select: none !important;
                    -webkit-touch-callout: none !important;
                    -webkit-tap-highlight-color: transparent !important;
                    -khtml-user-select: none !important;
                }
                input, textarea, [contenteditable] {
                    -webkit-user-select: text !important;
                    -moz-user-select: text !important;
                    -ms-user-select: text !important;
                    user-select: text !important;
                }
                ::selection { background: transparent !important; }
                ::-moz-selection { background: transparent !important; }
            `;
            document.head.appendChild(style);
        },
        
        // ÎìúÎûòÍ∑∏Ïï§ÎìúÎ°≠ Î∞©ÏßÄ
        disableDragDrop() {
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, true);
            
            document.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, true);
            
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                return false;
            }, true);
        },
        
        // ÏΩòÏÜî Í≤ΩÍ≥† Î©îÏãúÏßÄ Î∞è Í∞êÏãú
        setupConsoleWarning() {
            console.clear();
            console.log('%c‚ö†Ô∏è Î≥¥Ïïà Í≤ΩÍ≥†', 'color: red; font-size: 30px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);');
            console.log('%cÏù¥ Í∏∞Îä•ÏùÄ Í∞úÎ∞úÏûêÎ•º ÏúÑÌïú Í≤ÉÏûÖÎãàÎã§.\nÏïÖÏùòÏ†ÅÏù∏ ÏΩîÎìú ÏûÖÎ†•ÏùÄ Î≥¥ÏïàÏóê ÏúÑÌóòÌï† Ïàò ÏûàÏäµÎãàÎã§.', 'color: red; font-size: 16px; font-weight: bold;');
            console.log('%cÏ†ëÍ∑ºÏù¥ Ï†úÌïúÎêú ÏòÅÏó≠ÏûÖÎãàÎã§.', 'color: orange; font-size: 14px; background: yellow; padding: 2px;');
            
            // Ï£ºÍ∏∞Ï†Å ÏΩòÏÜî ÌÅ¥Î¶¨Ïñ¥ Î∞è Í≤ΩÍ≥†
            setInterval(() => {
                console.clear();
                console.log('%cüö´ Î¨¥Îã® Ï†ëÍ∑º Í∏àÏßÄ', 'color: red; font-size: 20px; font-weight: bold;');
                console.log('%cÍ∞úÎ∞úÏûê ÎèÑÍµ¨ ÏÇ¨Ïö©ÏùÑ Í∞êÏßÄÌñàÏäµÎãàÎã§.', 'color: orange; font-size: 14px;');
            }, 3000);
        },
        
        // Í∞úÎ∞úÏûêÎèÑÍµ¨ Í∞êÏßÄ
        detectDevTools() {
            let devtools = false;
            const threshold = 160;
            
            // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÌôîÎ°ú Í∞úÎ∞úÏûêÎèÑÍµ¨ Í∞êÏßÄ
            setInterval(() => {
                if (window.outerHeight - window.innerHeight > threshold || 
                    window.outerWidth - window.innerWidth > threshold) {
                    if (!devtools) {
                        devtools = true;
                        console.clear();
                        console.log('%cÍ∞úÎ∞úÏûê ÎèÑÍµ¨Í∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§!', 'color: red; font-size: 20px; font-weight: bold;');
                        console.log('%cÎ≥¥ÏïàÏùÑ ÏúÑÌï¥ ÌéòÏù¥ÏßÄ Í∏∞Îä•Ïù¥ Ï†úÌïúÎê©ÎãàÎã§.', 'color: orange; font-size: 14px;');
                    }
                } else {
                    devtools = false;
                }
            }, 500);
        }
    };

    // Í¥ÄÎ¶¨Ïûê Î™®Îìà
    const AdminModule = (function() {
        // ÏÑ§Ï†ïÍ∞íÎì§
        const config = {
            storageKey: 'ai_edu_kit_visitor_log',
            
            // ÎÇ†Ïßú Í∏∞Î∞ò ÎèôÏ†Å Í¥ÄÎ¶¨Ïûê ÌÇ§ ÏÉùÏÑ±
            generateAdminKey: function() {
                const today = new Date();
                const dateStr = today.getFullYear() + '' + 
                    (today.getMonth() + 1).toString().padStart(2, '0') + '' + 
                    today.getDate().toString().padStart(2, '0');
                return btoa('admin' + dateStr).substring(0, 8);
            },
            
            // Í¥ÄÎ¶¨Ïûê ÌÇ§ Í≤ÄÏ¶ù
            verifyAdmin: function(inputKey) {
                return inputKey === this.generateAdminKey();
            },
            
            // Î∞©Î¨∏Ïûê Î°úÍ∑∏ Í∞ÄÏ†∏Ïò§Í∏∞
            getVisitorLogs: function() {
                const logs = localStorage.getItem(this.storageKey);
                return logs ? JSON.parse(logs) : [];
            }
        };
        
        // CSV Îã§Ïö¥Î°úÎìú Í∏∞Îä•
        const downloadCSV = function() {
            const logs = config.getVisitorLogs();
            if (logs.length === 0) {
                alert('Îã§Ïö¥Î°úÎìúÌï† Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // CSV Ìó§Îçî
            const headers = ['Î≤àÌò∏', 'ÎÇ†Ïßú', 'ÏãúÍ∞Ñ', 'IPÏ£ºÏÜå', 'Íµ≠Í∞Ä', 'ÎèÑÏãú', 'Ï∞∏Ï°∞ÌéòÏù¥ÏßÄ', 'Î∞©Î¨∏ÏûêID', 'User Agent'];
            let csvContent = headers.join(',') + '\n';
            
            logs.forEach((log, index) => {
                const row = [
                    index + 1,
                    `"${log.date}"`,
                    `"${log.time}"`,
                    `"${log.ip}"`,
                    `"${log.country}"`,
                    `"${log.city}"`,
                    `"${log.referrer === 'direct' ? 'ÏßÅÏ†ë Ï†ëÏÜç' : log.referrer}"`,
                    `"${log.visitorId}"`,
                    `"${log.userAgent}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // UTF-8 BOM Ï∂îÍ∞ÄÎ°ú ÌïúÍ∏Ä Ïù∏ÏΩîÎî© ÏßÄÏõê
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ai_edu_kit_visitor_log_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        };
        
        // Î°úÍ∑∏ Î™®Îã¨ ÌëúÏãú
        const showLogModal = function() {
            const logs = config.getVisitorLogs();
            const logContent = document.getElementById('logContent');
            
            if (!logContent) {
                alert('Î°úÍ∑∏ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (logs.length === 0) {
                logContent.innerHTML = '<p class="text-gray-500 text-center py-8">ÏïÑÏßÅ Î∞©Î¨∏ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
            } else {
                let logHtml = `
                    <div class="mb-4 flex justify-between items-center">
                        <span class="text-sm text-gray-600">Ï¥ù ${logs.length}Í∞úÏùò Î∞©Î¨∏ Í∏∞Î°ù</span>
                        <span class="text-xs text-gray-500">ÏµúÍ∑º ÏóÖÎç∞Ïù¥Ìä∏: ${new Date().toLocaleString('ko-KR')}</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-200">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">Î≤àÌò∏</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">ÎÇ†Ïßú</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">ÏãúÍ∞Ñ</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">IP</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">Íµ≠Í∞Ä</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">ÎèÑÏãú</th>
                                    <th class="border border-gray-200 px-2 py-2 text-left text-xs">Ï∞∏Ï°∞</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // ÏµúÏã† Î°úÍ∑∏Î∂ÄÌÑ∞ ÌëúÏãú (ÏµúÎåÄ 100Í∞ú)
                const displayLogs = logs.slice(-100).reverse();
                displayLogs.forEach((log, index) => {
                    logHtml += `
                        <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50">
                            <td class="border border-gray-200 px-2 py-1 text-xs">${logs.length - index}</td>
                            <td class="border border-gray-200 px-2 py-1 text-xs">${log.date}</td>
                            <td class="border border-gray-200 px-2 py-1 text-xs">${log.time}</td>
                            <td class="border border-gray-200 px-2 py-1 text-xs font-mono">${log.ip}</td>
                            <td class="border border-gray-200 px-2 py-1 text-xs">${log.country}</td>
                            <td class="border border-gray-200 px-2 py-1 text-xs">${log.city}</td>
                            <td class="border border-gray-200 px-2 py-1 text-xs truncate max-w-32" title="${log.referrer}">${log.referrer === 'direct' ? 'ÏßÅÏ†ë' : log.referrer}</td>
                        </tr>
                    `;
                });
                
                logHtml += '</tbody></table></div>';
                if (logs.length > 100) {
                    logHtml += '<p class="text-xs text-gray-500 mt-2 text-center">ÏµúÍ∑º 100Í∞ú Í∏∞Î°ùÎßå ÌëúÏãúÎê©ÎãàÎã§. Ï†ÑÏ≤¥ Î°úÍ∑∏Îäî CSV Îã§Ïö¥Î°úÎìúÎ•º Ïù¥Ïö©ÌïòÏÑ∏Ïöî.</p>';
                }
                logContent.innerHTML = logHtml;
            }
            
            const modal = document.getElementById('logModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        };
        
        // ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Ï°∞Ìöå
        const getStats = function() {
            const logs = config.getVisitorLogs();
            const today = new Date().toLocaleDateString('ko-KR');
            const thisWeek = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toLocaleDateString('ko-KR');
            
            return {
                total: logs.length,
                today: logs.filter(log => log.date === today).length,
                thisWeek: logs.filter(log => new Date(log.timestamp) >= new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length,
                unique: new Set(logs.map(log => log.visitorId)).size,
                countries: [...new Set(logs.map(log => log.country))].length
            };
        };
        
        return {
            // Í¥ÄÎ¶¨Ïûê Î™®Îìà Ï¥àÍ∏∞Ìôî
            init: function() {
                // Ctrl+Shift+A ÌÇ§ Ï°∞Ìï©ÏúºÎ°ú Í¥ÄÎ¶¨Ïûê Ìå®ÎÑê ÌôúÏÑ±Ìôî
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const inputKey = prompt('üîê Ïò§ÎäòÏùò Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
                        if (config.verifyAdmin(inputKey)) {
                            const adminPanel = document.getElementById('adminPanel');
                            if (adminPanel) {
                                adminPanel.classList.remove('hidden');
                                alert('‚úÖ Í¥ÄÎ¶¨Ïûê Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.');
                                console.clear();
                                console.log('%cÍ¥ÄÎ¶¨Ïûê Î™®Îìú ÌôúÏÑ±Ìôî', 'color: green; font-size: 16px; font-weight: bold;');
                            }
                        } else if (inputKey) {
                            alert('‚ùå ÏûòÎ™ªÎêú Ïù∏Ï¶ù ÏΩîÎìúÏûÖÎãàÎã§.');
                            console.clear();
                            console.log('%cÏûòÎ™ªÎêú Ï†ëÍ∑º ÏãúÎèÑ', 'color: red; font-size: 14px;');
                        }
                    }
                });
                
                // Í¥ÄÎ¶¨Ïûê Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
                const showLogBtn = document.getElementById('showLogBtn');
                const downloadLogBtn = document.getElementById('downloadLogBtn');
                
                if (showLogBtn) {
                    showLogBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        showLogModal();
                    });
                }
                
                if (downloadLogBtn) {
                    downloadLogBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        downloadCSV();
                    });
                }
            },
            
            // Í∞úÎ∞úÏûêÏö© Í¥ÄÎ¶¨Ïûê ÏΩîÎìú Ï°∞Ìöå (Î∞∞Ìè¨Ïãú Ï†úÍ±∞ Í∂åÏû•)
            getAdminCode: function() {
                return config.generateAdminKey();
            },
            
            // ÌÜµÍ≥Ñ Ï†ïÎ≥¥ Ï°∞Ìöå
            getStats: getStats
        };
    })();

    // Ï∂îÍ∞Ä Î≥¥Ïïà: Ïä§ÌÅ¨Î¶ΩÌä∏ Ï°∞Ïûë Î∞©ÏßÄ
    Object.freeze(SecurityModule);
    Object.freeze(AdminModule);

    // Ï∂îÍ∞Ä Î≥¥Ïïà Í∏∞Îä•
    (function() {
        // eval Ìï®Ïàò ÎπÑÌôúÏÑ±Ìôî
        window.eval = function() {
            throw new Error('eval() Ìï®ÏàòÎäî Î≥¥ÏïàÏÉÅ ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.');
        };
        
        // Function ÏÉùÏÑ±Ïûê ÎπÑÌôúÏÑ±Ìôî
        window.Function = function() {
            throw new Error('Function ÏÉùÏÑ±ÏûêÎäî Î≥¥ÏïàÏÉÅ ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§.');
        };
        
        // setTimeout/setIntervalÏóêÏÑú Î¨∏ÏûêÏó¥ Ïã§Ìñâ Î∞©ÏßÄ
        const originalSetTimeout = window.setTimeout;
        const originalSetInterval = window.setInterval;
        
        window.setTimeout = function(callback, delay) {
            if (typeof callback === 'string') {
                throw new Error('setTimeoutÏóêÏÑú Î¨∏ÏûêÏó¥ ÏΩîÎìú Ïã§ÌñâÏùÄ Î≥¥ÏïàÏÉÅ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.');
            }
            return originalSetTimeout.apply(this, arguments);
        };
        
        window.setInterval = function(callback, delay) {
            if (typeof callback === 'string') {
                throw new Error('setIntervalÏóêÏÑú Î¨∏ÏûêÏó¥ ÏΩîÎìú Ïã§ÌñâÏùÄ Î≥¥ÏïàÏÉÅ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.');
            }
            return originalSetInterval.apply(this, arguments);
        };
    })();

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î≥¥Ïïà Î∞è Í¥ÄÎ¶¨Ïûê Î™®Îìà Ï¥àÍ∏∞Ìôî
    if (typeof window !== 'undefined') {
        // Ï¶âÏãú Î≥¥Ïïà Î™®Îìà ÌôúÏÑ±Ìôî
        SecurityModule.init();
        
        // DOM Î°úÎìú ÌõÑ Í¥ÄÎ¶¨Ïûê Î™®Îìà Ï¥àÍ∏∞Ìôî
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                AdminModule.init();
            });
        } else {
            AdminModule.init();
        }
        
        // Í∞úÎ∞úÏö© Í¥ÄÎ¶¨Ïûê ÏΩîÎìú ÌëúÏãú (Î∞∞Ìè¨Ïãú Ï†úÍ±∞)
        setTimeout(function() {
            console.clear();
            console.log('%cüîë Ïò§ÎäòÏùò Í¥ÄÎ¶¨Ïûê ÏΩîÎìú', 'color: blue; font-size: 14px; font-weight: bold; background: lightblue; padding: 2px 8px; border-radius: 4px;');
            console.log('%c' + AdminModule.getAdminCode(), 'color: blue; font-size: 16px; font-weight: bold; background: yellow; padding: 4px 8px; border-radius: 4px;');
            console.log('%cCtrl+Shift+A ÌÇ§Î°ú Í¥ÄÎ¶¨Ïûê Ìå®ÎÑêÏùÑ ÌôúÏÑ±ÌôîÌïòÏÑ∏Ïöî.', 'color: gray; font-size: 12px;');
            
            // ÌÜµÍ≥Ñ Ï†ïÎ≥¥ÎèÑ ÌëúÏãú
            const stats = AdminModule.getStats();
            console.log('%cüìä ÌòÑÏû¨ ÌÜµÍ≥Ñ', 'color: green; font-size: 12px; font-weight: bold;');
            console.table(stats);
        }, 1000);
        
        // Ï†ÑÏó≠ Í∞ùÏ≤¥Î°ú ÎÖ∏Ï∂ú (Í∞úÎ∞úÏö©)
        window.AdminModule = AdminModule;
    }

})();